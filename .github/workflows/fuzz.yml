name: Agent Loop — Fuzz & Roundtrip

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      rounds:
        description: 'Fuzz rounds'
        default: '5000'
      seed:
        description: 'Random seed (empty = random)'
        default: ''

jobs:
  fuzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest hypothesis

      - name: Run fuzz tests
        id: fuzz
        continue-on-error: true
        run: |
          cd src
          ROUNDS=${{ github.event.inputs.rounds || '5000' }}
          python xi_fuzz.py $ROUNDS > ../fuzz_report.json 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Run eval harness
        id: eval
        continue-on-error: true
        run: |
          cd src && python xi_eval_harness.py > ../eval_report.json 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Run unit tests
        id: tests
        continue-on-error: true
        run: |
          pytest tests/ -q --tb=short > test_report.txt 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Generate dataset sample
        continue-on-error: true
        run: |
          cd src && python xi_dataset.py 50 2>/dev/null || true

      - name: Check for counterexamples
        if: steps.fuzz.outputs.exit_code != '0'
        run: |
          echo "## ⚠️ Fuzz found counterexamples" >> $GITHUB_STEP_SUMMARY
          python3 -c "
          import json
          with open('fuzz_report.json') as f:
              report = json.load(f)
          ce = report.get('counterexamples', [])
          print(f'Found {len(ce)} counterexamples')
          for c in ce[:5]:
              print(f'  - {c[\"property\"]}: {c.get(\"error\", \"unknown\")}')
          "

      - name: Create issue on failure
        if: steps.fuzz.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = {};
            try {
              report = JSON.parse(fs.readFileSync('fuzz_report.json', 'utf8'));
            } catch(e) {
              report = {summary: {failed: 'unknown'}, counterexamples: []};
            }

            const ce = report.counterexamples || [];
            const body = [
              `## Fuzz Counterexample Report`,
              ``,
              `**Run:** ${new Date().toISOString()}`,
              `**Seed:** ${report.seed || 'unknown'}`,
              `**Failed checks:** ${report.summary?.failed || 'unknown'}`,
              `**Pass rate:** ${report.summary?.pass_rate || 'unknown'}`,
              ``,
              `### Counterexamples (first 5)`,
              ``,
              ...ce.slice(0, 5).map((c, i) =>
                `**${i+1}. ${c.property}**\n\`\`\`json\n${JSON.stringify(c, null, 2)}\n\`\`\``
              ),
              ``,
              `### Reproducer`,
              `\`\`\`bash`,
              `cd src && python xi_fuzz.py 1000 # seed: ${report.seed}`,
              `\`\`\``,
              ``,
              `_Auto-generated by agent loop._`,
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Agent] Fuzz counterexample: ${ce[0]?.property || 'unknown property'}`,
              body: body,
              labels: ['bug', 'agent-found', 'fuzz'],
            });

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-reports-${{ github.run_id }}
          path: |
            fuzz_report.json
            eval_report.json
            test_report.txt

      - name: Summary
        if: always()
        run: |
          echo "## Agent Loop Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fuzz | ${{ steps.fuzz.outputs.exit_code == '0' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Eval Harness | ${{ steps.eval.outputs.exit_code == '0' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ steps.tests.outputs.exit_code == '0' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
